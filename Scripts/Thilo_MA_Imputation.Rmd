---
title: "Thilo_MA_Imputation"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages and Data

```{r, message=FALSE}
library(tidyverse)
library(mice)
library(ggmice)

df_final <- readRDS("df_final.RData")
demo_data <- readRDS("demo_data.RData")

```


## Missing Data Analysis

### Missing Data Pattern

```{r}
na_ind <- data.frame(!is.na(df_final)) + 0

```

```{r}
sum(!complete.cases(df_final))/length(df_final$patient)
```


### Missing Data Mechanisms

#### Compare Missing Post to Not-Missing Post BDI

```{r}
df_plot <- df_final %>% 
  mutate(BDI_missing = ifelse(is.na(df_final$BDI_post),
                              "Missing", "Not Missing"))

df_long <- df_plot %>%
  pivot_longer(cols = c(mean_pos_T5, mean_neg_T5, rmssd_pos_T5, rmssd_neg_T5,
                        mean_pos_T55, mean_neg_T55, rmssd_pos_T55, rmssd_neg_T55),
               names_to = "Variable",
               values_to = "Value")

ggplot(df_long, aes(x = BDI_missing, y = Value)) +
  geom_boxplot() +
  facet_wrap(~Variable, scales = "free") +
  labs(x = "Post BDI Missingness", y = "Value",
       title = "Comparison of Variables by BDI_post Missingness")

```


# Imputation Model

### Merge Data

```{r}
df_imp <- merge(demo_data,  df_final, 
                by = "patient")
```


### Prepare Imputation

```{r}
method_vec <- make.method(df_imp)

# Passive Imputation
method_vec["delta_dep"] <- "~I(BDI_post - BDI_prae)"

print(method_vec)
```

```{r}
pred_mat <- quickpred(df_imp, exclude = c("patient", "delta_dep", 
                                          "delta_mean_pos", "delta_mean_neg",
                                          "delta_rmssd_pos", "delta_rmssd_neg"))

plot_pred(pred_mat, label = F, rotate = T)
```

## MAR Imputation Model

```{r}
imp_MAR_test <- futuremice(df_imp,
                           method = method_vec,
                           predictorMatrix = pred_mat,
                           m = 5, maxit = 30,
                           parallelseed = 2025)

```

```{r}
imp_MAR_test$loggedEvents
```

```{r}
plot(imp_MAR_test, layout = c(2, 5))
```


```{r}
densityplot(imp_MAR_test, layout = c(2, 2))
```


### Full Model

```{r}
imp_MAR <- futuremice(df_imp,
                      method = method_vec,
                      predictorMatrix = pred_mat,
                      m = 50, maxit = 30,
                      parallelseed = 2025)
saveRDS(imp_MAR, "imp_MAR.RData")
```



## MNAR Imputation Models

### MNAR1

#### Post processing command

We will add an offset of 5 (i.e. 0.5 SD) to each missing BDI value.
To ensure realistic imputations, we will add less to participants with imputed
values close to the maximum value of 63.

```{r}
post1 <- make.post(df_imp)

post1["BDI_prae"] <- "imp[[j]][,i] <- ifelse(imp[[j]][,i] < 63,
imp[[j]][,i] + pmin(5, 63 - imp[[j]][,i]), imp[[j]][,i])"

post1["BDI_post"] <- "imp[[j]][,i] <- ifelse(imp[[j]][,i] < 63,
imp[[j]][,i] + pmin(5, 63 - imp[[j]][,i]), imp[[j]][,i])"

```



```{r}
imp_MNAR1_test <- futuremice(df_imp,
                             method = method_vec,
                             predictorMatrix = pred_mat,
                             post = post1,
                             m = 5, maxit = 30,
                             parallelseed = 2025)
```


```{r}
imp_MNAR1_test$loggedEvents
```

```{r}
plot(imp_MNAR1_test, layout = c(2, 5))
```

```{r}
densityplot(imp_MNAR1_test, layout = c(2, 2))
```

##### Full Model MNAR1

```{r}
imp_MNAR1 <- futuremice(df_imp,
                        method = method_vec,
                        predictorMatrix = pred_mat,
                        post = post1,
                        m = 50, maxit = 30,
                        parallelseed = 2025)
saveRDS(imp_MNAR1, "imp_MNAR1.RData")
```




### MNAR2

#### Post processing command

```{r}
post2 <- make.post(df_imp)

post2["BDI_prae"] <- "imp[[j]][,i] <- ifelse(imp[[j]][,i] > 0,
imp[[j]][,i] - pmin(5, imp[[j]][,i]), imp[[j]][,i])"

post2["BDI_post"] <- "imp[[j]][,i] <- ifelse(imp[[j]][,i] > 0,
imp[[j]][,i] - pmin(5, imp[[j]][,i]), imp[[j]][,i])"

```



```{r}
imp_MNAR2_test <- futuremice(df_imp,
                             method = method_vec,
                             predictorMatrix = pred_mat,
                             post = post2,
                             m = 5, maxit = 30,
                             parallelseed = 2025)

```


```{r}
imp_MNAR2_test$loggedEvents
```

```{r}
plot(imp_MNAR2_test, layout = c(2, 5))
```

```{r}
densityplot(imp_MNAR2_test, layout = c(2, 2))
```


##### Full Model MNAR2

```{r}
imp_MNAR2 <- futuremice(df_imp,
                        method = method_vec,
                        predictorMatrix = pred_mat,
                        post = post2,
                        m = 50, maxit = 30,
                        parallelseed = 2025)
saveRDS(imp_MNAR2, "imp_MNAR2.RData")
```


